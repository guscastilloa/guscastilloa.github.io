import speakerViewHTML from"./speaker-view.html";import{marked}from"marked";const Plugin=()=>{function e(){if(l&&!l.closed)l.focus();else{if((l=window.open("about:blank","reveal.js - Notes","width=1100,height=700")).marked=marked,l.document.write(speakerViewHTML),!l)return void alert("Speaker view popup failed to open. Please make sure popups are allowed and reopen the speaker view.");n()}}function t(e){l&&!l.closed?l.focus():(l=e,window.addEventListener("message",s),r())}function n(){const e=d.getConfig().url,t="string"==typeof e?e:window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;i=setInterval(function(){l.postMessage(JSON.stringify({namespace:"reveal-notes",type:"connect",state:d.getState(),url:t}),"*")},500),window.addEventListener("message",s)}function a(e,t,n){let a=d[e].apply(d,t);l.postMessage(JSON.stringify({namespace:"reveal-notes",type:"return",result:a,callId:n}),"*")}function o(){let e=d.getCurrentSlide(),t=e.querySelector("aside.notes"),n=e.querySelector(".current-fragment"),a={namespace:"reveal-notes",type:"state",notes:"",markdown:!1,whitespace:"normal",state:d.getState()};if(e.hasAttribute("data-notes")&&(a.notes=e.getAttribute("data-notes"),a.whitespace="pre-wrap"),n){let e=n.querySelector("aside.notes");e?t=e:n.hasAttribute("data-notes")&&(a.notes=n.getAttribute("data-notes"),a.whitespace="pre-wrap",t=null)}t&&(a.notes=t.innerHTML,a.markdown="string"==typeof t.getAttribute("data-markdown")),l.postMessage(JSON.stringify(a),"*")}function s(e){let t=JSON.parse(e.data);t&&"reveal-notes"===t.namespace&&"connected"===t.type?(clearInterval(i),r()):t&&"reveal-notes"===t.namespace&&"call"===t.type&&a(t.methodName,t.arguments,t.callId)}function r(){d.on("slidechanged",o),d.on("fragmentshown",o),d.on("fragmenthidden",o),d.on("overviewhidden",o),d.on("overviewshown",o),d.on("paused",o),d.on("resumed",o),o()}let i,d,l=null;return{id:"notes",init:function(n){d=n,/receiver/i.test(window.location.search)||(null!==window.location.search.match(/(\?|\&)notes/gi)?e():window.addEventListener("message",e=>{if(!l&&"string"==typeof e.data){let a;try{a=JSON.parse(e.data)}catch(n){}a&&"reveal-notes"===a.namespace&&"heartbeat"===a.type&&t(e.source)}}),d.addKeyBinding({keyCode:83,key:"S",description:"Speaker notes view"},function(){e()}))},open:e}};export default Plugin;