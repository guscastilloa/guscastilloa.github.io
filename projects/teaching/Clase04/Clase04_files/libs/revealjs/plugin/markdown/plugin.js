/*!
 * The reveal.js markdown plugin. Handles parsing of
 * markdown inside of presentations as well as loading
 * of external markdown documents.
 */
import{marked}from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_NOTES_SEPARATOR="notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{function e(e){var t=(e.querySelector("[data-template]")||e.querySelector("script")||e).textContent,r=(t=t.replace(new RegExp(SCRIPT_END_PLACEHOLDER,"g"),"</script>")).match(/^\n?(\s*)/)[1].length,a=t.match(/^\n?(\t*)/)[1].length;return a>0?t=t.replace(new RegExp("\\n?\\t{"+a+"}","g"),"\n"):r>1&&(t=t.replace(new RegExp("\\n? {"+r+"}","g"),"\n")),t}function t(e){for(var t=e.attributes,r=[],a=0,n=t.length;a<n;a++){var o=t[a].name,s=t[a].value;/data\-(markdown|separator|vertical|notes)/gi.test(o)||(s?r.push(o+'="'+s+'"'):r.push(o))}return r.join(" ")}function r(e){return(e=e||{}).separator=e.separator||DEFAULT_SLIDE_SEPARATOR,e.notesSeparator=e.notesSeparator||DEFAULT_NOTES_SEPARATOR,e.attributes=e.attributes||"",e}function a(e,t){t=r(t);var a=e.split(new RegExp(t.notesSeparator,"mgi"));return 2===a.length&&(e=a[0]+'<aside class="notes">'+marked(a[1].trim())+"</aside>"),'<script type="text/template">'+(e=e.replace(/<\/script>/g,SCRIPT_END_PLACEHOLDER))+"</script>"}function n(e,t){t=r(t);for(var n,o,s,i=new RegExp(t.separator+(t.verticalSeparator?"|"+t.verticalSeparator:""),"mg"),u=new RegExp(t.separator),d=0,l=!0,c=[];n=i.exec(e);){!(o=u.test(n[0]))&&l&&c.push([]),s=e.substring(d,n.index),o&&l?c.push(s):c[c.length-1].push(s),d=i.lastIndex,l=o}(l?c:c[c.length-1]).push(e.substring(d));for(var E="",p=0,m=c.length;p<m;p++)c[p]instanceof Array?(E+="<section "+t.attributes+">",c[p].forEach(function(e){E+="<section data-markdown>"+a(e,t)+"</section>"}),E+="</section>"):E+="<section "+t.attributes+" data-markdown>"+a(c[p],t)+"</section>";return E}function o(r){return new Promise(function(a){var o=[];[].slice.call(r.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach(function(r){r.getAttribute("data-markdown").length?o.push(s(r).then(function(e){r.outerHTML=n(e.responseText,{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:t(r)})},function(e,t){r.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+t+" failed with HTTP status "+e.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"})):r.outerHTML=n(e(r),{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:t(r)})}),Promise.all(o).then(a)})}function s(e){return new Promise(function(t,r){var a=new XMLHttpRequest,n=e.getAttribute("data-markdown"),o=e.getAttribute("data-charset");null!=o&&""!=o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(e,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?t(a,n):r(a,n))}.bind(this,e,a),a.open("GET",n,!0);try{a.send()}catch(s){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+s),t(a,n)}})}function i(e,t,r){var a,n,o=new RegExp(r,"mg"),s=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg"),i=e.nodeValue;if(a=o.exec(i)){var u=a[1];for(i=i.substring(0,a.index)+i.substring(o.lastIndex),e.nodeValue=i;n=s.exec(u);)n[2]?t.setAttribute(n[1],n[2]):t.setAttribute(n[3],"");return!0}return!1}function u(e,t,r,a,n){if(null!=t&&t.childNodes!=undefined&&t.childNodes.length>0)for(var o=t,s=0;s<t.childNodes.length;s++){var d=t.childNodes[s];if(s>0)for(var l=s-1;l>=0;){var c=t.childNodes[l];if("function"==typeof c.setAttribute&&"BR"!=c.tagName){o=c;break}l-=1}var E=e;"section"==d.nodeName&&(E=d,o=d),"function"!=typeof d.setAttribute&&d.nodeType!=Node.COMMENT_NODE||u(E,d,o,a,n)}t.nodeType==Node.COMMENT_NODE&&0==i(t,r,a)&&i(t,e,n)}function d(){var t=c.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(t).forEach(function(t){t.setAttribute("data-markdown-parsed",!0);var r=t.querySelector("aside.notes"),a=e(t);t.innerHTML=marked(a),u(t,t,null,t.getAttribute("data-element-attributes")||t.parentNode.getAttribute("data-element-attributes")||DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR,t.getAttribute("data-attributes")||t.parentNode.getAttribute("data-attributes")||DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR),r&&t.appendChild(r)}),Promise.resolve()}function l(e){return e.replace(/([&<>'"])/g,e=>HTML_ESCAPE_MAP[e])}let c;return{id:"markdown",init:function(e){c=e;let{renderer:t,animateLists:r,...a}=c.getConfig().markdown||{};return t||((t=new marked.Renderer).code=((e,t)=>{let r="";return CODE_LINE_NUMBER_REGEX.test(t)&&(r=`data-line-numbers="${r=t.match(CODE_LINE_NUMBER_REGEX)[1].trim()}"`,t=t.replace(CODE_LINE_NUMBER_REGEX,"").trim()),`<pre><code ${r} class="${t}">${e=l(e)}</code></pre>`})),!0===r&&(t.listitem=(e=>`<li class="fragment">${e}</li>`)),marked.setOptions({renderer:t,...a}),o(c.getRevealElement()).then(d)},processSlides:o,convertSlides:d,slidify:n,marked:marked}};export default Plugin;